<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>containergl example</title>
    <style rel="stylesheet">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
        }

        body {
            background: #ffffff;
            width: 100%;
            height: 100%;
        }

        #canvas-frame {
            width: 100%;
            height: 100%;
            background: #091E25;

            /*width: 1920px;
            height: 1080px;
            background-image: url(bgImg/bg.png);*/
        }

        /*#left {
            position: absolute;
            top: 0;
            width: 389px;
            height: 1080px;
            z-index: 5;
            background-image: url(bgImg/left.png);
        }
        #right {
            position: absolute;
            top: 0;
            right: 0;
            width: 389px;
            height: 1080px;
            z-index: 5;
            background-image: url(bgImg/right.png);
        }
        #bottom {
            position: absolute;
            bottom: 0;
            width: 1920px;
            height: 379px;
            z-index: 5;
            background-image: url(bgImg/bottom.png);
        }*/

    </style>
</head>

<body>
    <div id="canvas-frame"></div>

<script type="text/javascript" src="./libs.min.js"></script></body>
<script type="text/javascript" src="./glInstance.min.js"></script></body>



<script>
    
const instance = new glInstance();

window._instance = instance;
// gui
// datGui(instance);
const loadeComp = {
    name: 'LoaderModel', // 当前组件的名称 用于调用对应的组件
    id: 'model1', // 当前组件的key值 用于监控当前组件的变化或者事件

    config: {
        order: false, // true 按照顺序加载 false 一起加载
        chassis: {
            radius: 10000,
            position: {
                x: 0,
                y: -50,
                z: 0
            },
            gradient: [
                'rgba(10,13,26,1)',
                'rgba(10,13,26,0.0)',
            ]
        }, // 配置底盘显示  装饰作用
        model: [
            {
                url: './models/taikang.FBX',
                id: 'index_1',
                replaceMaterial: 'MeshPhysicalMaterial', // 是否替换材质
                pick: [], // 拾取的物体  'all' 为所有物体
                animate: [{
                    name: 'Main_Rotor',
                    rotation: {
                        z: 8
                    }
                }], // 需要控制的动画物体
                bake: [{
                    name: 'load',
                    uv2: 'loadRay'
                }],
                mesh: [
                    {
                        name: 'Glass_02',
                        renderOrder: 10
                    }, {
                        name: 'Glass_01',
                        renderOrder: 15
                    }, {
                        name: 'Box01',
                        renderOrder: 1,
                        effects: {
                            name: 'diffusion', // 扩散效果
                            radius: 2500, // 自动 读取当前geometry的radius
                            center: { x: 55, y: 0, z: 0 },
                            range: 0.05, // 扩散范围半径范围  0 - 1  读取radius作为基数
                            color: new THREE.Color("#fff"),
                            speed: 0.15
                        }
                    }, {
                        name: 'Box02',
                        renderOrder: 2,
                        effects: {
                            name: 'diffusion', // 扩散效果
                            radius: 2500, // 自动 读取当前geometry的radius
                            center: { x: 55, y: 0, z: 0 },
                            range: 0.05, // 扩散范围半径范围  0 - 1  读取radius作为基数
                            color: new THREE.Color("#fff"),
                            speed: 0.15
                        }
                    }, {
                        name: 'metal',
                        renderOrder: 30
                    }, {
                        name: 'building',
                        renderOrder: 0
                    }],
                material: [
                    {
                        name: 'glass05',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.05,
                        metalness: 0.4,
                        clearcoat: 0.9,
                        clearcoatRoughness: 0.1,
                        transparent: true,
                        side: 2,
                        opacity: 0.7,
                        color: new THREE.Color("#91794D"),
                        sheen: new THREE.Color("#80A5AD"),
                        transmission: 0.05,
                        ior: 2.3,
                        map: 'box_glass'
                    },
                    {
                        name: 'glass06',
                        vertexColors: false,
                        roughness: 0.05,
                        metalness: 0.4,
                        clearcoat: 0.9,
                        clearcoatRoughness: 0.1,
                        transparent: true,
                        opacity: 0.5,
                        side: 2,
                        color: new THREE.Color("#43555B"),
                        sheen: new THREE.Color("#80A5AD"),
                        transmission: 0.05,
                        ior: 2.3,
                        map: 'box_glass'
                    },
                    {
                        name: 'glass04',
                        vertexColors: false,
                        roughness: 0.0,
                        metalness: 0.5,
                        clearcoat: 0.4,
                        clearcoatRoughness: 0.05,
                        reflectivity: 0.2,
                        sheen: new THREE.Color("#80A5AD")
                    },
                    {
                        name: 'glass01',
                        roughness: 0.0,
                        metalness: 0.5,
                        clearcoat: 0.4,
                        clearcoatRoughness: 0.05,
                        reflectivity: 0.2,
                        ior: 1.8,
                        sheen: new THREE.Color("#80A5AD")
                    },
                    {
                        name: 'glass02',
                        roughness: 0.1,
                        metalness: 0.4,
                        clearcoat: 0.4,
                        clearcoatRoughness: 0.05
                    },
                    {
                        name: 'metal',
                        roughness: 0.1,
                        metalness: 0.4,
                        clearcoat: 0.4,
                        clearcoatRoughness: 0.05
                    },
                    {
                        name: 'Material #1734567734',
                        roughness: 0.1,
                        metalness: 0.4,
                        clearcoat: 0.4,
                        clearcoatRoughness: 0.05
                    },
                    {
                        name: 'glass03',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.1,
                        metalness: 0.1,
                        clearcoat: 0.15,
                        clearcoatRoughness: 0.1,
                        transparent: true
                    },
                    {
                        name: 'tree01',
                        side: 2,
                        // opacity: 1.3,
                        alphaTest: 0.4,
                        // depthWrite: false,
                        // transparent: true
                    },
                    {
                        name: 'tree02',
                        side: 2,
                        // depthWrite: false,
                        // opacity: 1.3,
                        alphaTest: 0.4,
                        // transparent: true
                    },
                    {
                        name: 'Material #1734567865',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.5,
                        metalness: 0.6,
                        clearcoat: 0.3,
                        clearcoatRoughness: 0.05,

                    },
                    {
                        name: 'Material #1734568790',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.5,
                        metalness: 0.6,
                        clearcoat: 0.3,
                        clearcoatRoughness: 0.05,
                        transparent: true
                    },
                    {
                        name: 'Material #625',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.9,
                        metalness: 0.0,
                        clearcoat: 0.0,
                        clearcoatRoughness: 0.5,
                        color: new THREE.Color("#363636")
                        // transparent: true
                    },
                    {
                        name: 'load',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.5,
                        metalness: 0.1,
                        clearcoat: 0.1,
                        clearcoatRoughness: 0.7,
                        reflectivity: 0.1,
                        ior: 1.2,
                        // transparent: true
                    }, // 地板
                    {
                        name: 'Material #1734568901.001',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.1,
                        metalness: 0.4,
                        clearcoat: 0.5,
                        clearcoatRoughness: 0.9
                        // transparent: true
                    }, //飞机
                    {
                        name: 'water',
                        alphaMap: null,
                        vertexColors: false,
                        roughness: 0.1,
                        metalness: 0.3,
                        clearcoat: 0.2,
                        clearcoatRoughness: 0.4,
                        normalMap: 'waternormals',
                        bumpMap: 'water',
                        color: new THREE.Color('#999'),
                        animate: {
                            map: { x: 0.01, y: 0.1 }
                        }
                    }, //水
                    {
                        name: 'Material #673',
                        color: new THREE.Color('#aaa'),
                        roughness: 0.1,
                        metalness: 0.2,
                    }, //水
                ], // 修改材质的属性

            }
        ]
    },
    renderOrder: 0, // 当前组件的渲染层级
    renderSort: 1, // 当前组件的渲染顺序
    created() {
        /* 生成组件后的生命周期 （在生成效果前） */
        // console.log("created");
    },
    mounted(group) {
        /* 组件创建完成并且效果完成后的回调 */
        // console.log("mounted");

        // 拿到镜头动画组件
        setTimeout(() => {
            var path = _instance.getComponent({
                sort: 2
            });
            path.start("path_1")
        }, 1000)
    },
    destroyed() {
        /* 当前组件销毁后执行的回调 */
        console.log("destroyed");
    },
    update(object) {
        /* 当前组件中的mesh发生变化 触发 */
        // console.log(object);
    },
    watch(object) {
        /* 当前组件每次修改效果后的回调 增删改 */
        console.log("watch");
    }
};

/*
{
    camera: {x: 14.04, y: 1781.07, z: 4.3},
target: {x: -36.86, y: 32, z: -27.98}
},
{
    camera: {x: 14.04, y: 519.43, z: 4.3},
    target: {x: -36.86, y: 32, z: -27.98}
},
{
    camera: {x: 0.87, y: 291.77, z: 81.74},
target: {x: 12.97, y: 32, z: -214.54}
}

*/
const cameraComp = {
    name: 'CameraAnimate', // 当前组件的名称 用于调用对应的组件
    id: 'Path_1', // 当前组件的key值 用于监控当前组件的变化或者事件
    config: {
        data: [{
            id: 'path_1',
            time: 23000,
            easing: 'Quartic.InOut', // 当前动画的缓动 可以添加导子数据上
            cohesion: false, // 是否衔接当前视角过度
            data: [
                { "camera": { "x": -1.55, "y": 959.98, "z": 1.86 }, "target": { "x": -1.54, "y": 200, "z": -2.45 }, speed: 1 },
                { "camera": { "x": -3.1, "y": 305.83, "z": 75.47 }, "target": { "x": -1.54, "y": 200, "z": -2.45 } },
                {
                    type: 'spin',
                    angle: [0, 3.14],
                    speed: 2
                },
                { "camera": { "x": 145.6, "y": 280.57, "z": -87.32 }, "target": { "x": 145.7, "y": 5, "z": 147.56 } },
                { "camera": { "x": 153.28, "y": 8.48, "z": 70.44 }, "target": { "x": 148.46, "y": 5, "z": 135.15 } },
                { "camera": { "x": 167.53, "y": 8.46, "z": 169.35 }, "target": { "x": -86.85, "y": 5, "z": 168.38 } },
                { "camera": { "x": -190.13, "y": 8.98, "z": 168.9 }, "target": { "x": -301.46, "y": 5, "z": 164.45 } },
                // { "camera": { "x": -254.22, "y": 60.37, "z": 159.08 }, "target": { "x": -188.32, "y": 5, "z": 64.67 } },
                // { "camera": { "x": -350.89, "y": 164.61, "z": 230.48 }, "target": { "x": -140.3, "y": 5, "z": 92.86 } },
                { "camera": { "x": -878.38, "y": 130.24, "z": 318.11 }, "target": { "x": 207.69, "y": 32, "z": -418.96 } },
                { "camera": { "x": -96.86, "y": 299.3, "z": 190.76 }, "target": { "x": 87.02, "y": 32, "z": -104.8 } }
            ]
        }]
    },
    renderOrder: 0, // 当前组件的渲染层级
    renderSort: 2, // 当前组件的渲染顺序
    created() {
        /* 生成组件后的生命周期 （在生成效果前） */
        // console.log("created");
    },
    mounted(group) {
        /* 组件创建完成并且效果完成后的回调 */
        console.log("mounted");
    },
    destroyed() {
        /* 当前组件销毁后执行的回调 */
        console.log("destroyed");
    },
    update() {
        /* 当前组件中的mesh发生变化 触发 */
        console.log("update");
    },
    watch(object) {
        /* 当前组件每次修改效果后的回调 增删改 */
        console.log("watch");
    },
    eftEnd() {
        console.log("end");
        setTimeout(() => {
            _instance.getComponent({ sort: 4 }).setConfig('show', {
                time: 1600,
                callback: function () {
                    setTimeout(() => {
                        _instance.getComponent({ sort: 4 }).setConfig('hide');
                    }, 3000)
                }
            });
        }, 400)
    }
};

const glowsComp = {
    name: 'GlowsEft',
    id: 'test_glows',
    renderOrder: 5, // 当前组件的渲染层级
    renderSort: 3, // 当前组件的渲染顺序
    config: {
        gridHelper: true, // 显示辅助网格
    }
};

const htMapComp = {
    name: 'HtMapEft',
    id: 'test_htMap',
    renderSort: 4, // 当前组件的渲染顺序
    config: {
        maximum: 'auto', // 最大值  number / 'auto'; auto-取数据的最大值
        minimum: 0, // 最小值  number / 'auto'; auto-取数据的最小值
        maxcolor: "#4185AF", //最大值颜色 默认 #FF0000
        mincolor: "#4185AF", //最小值颜色 默认 #0000FF
        height: 50, //三维热力最大高度
        opacity: 0.7, //透明度     取值 0 ~ 1
        segments: 300, //细分段数，决定精细度
        blurRadius: 100, //模糊半径
        offsetY: 1, // 高度位置
        cameraP: { x: 574, y: 658, z: 559 }, //热力显示时的相机位置
        data: [{ "vec": [239, -362], "weight": 488 }, { "vec": [399, -338], "weight": 132 },
        { "vec": [260, -238], "weight": 308 }, { "vec": [646, -57], "weight": 209 },
        { "vec": [518, -196], "weight": 341 }, { "vec": [554, 41], "weight": 231 },
        { "vec": [327, 34], "weight": 26 }, { "vec": [450, 252], "weight": 78 },
        { "vec": [630, 142], "weight": 49 }, { "vec": [512, 422], "weight": 71 },
        { "vec": [322, 267], "weight": 342 }, { "vec": [144, 413], "weight": 206 },
        { "vec": [10, 422], "weight": 352 }, { "vec": [-197, 434], "weight": 292 },
        { "vec": [-366, 360], "weight": 484 }, { "vec": [-458, 327], "weight": 340 },
        { "vec": [-510, 368], "weight": 261 }, { "vec": [-638, -54], "weight": 91 },
        { "vec": [-471, -175], "weight": 428 }, { "vec": [-312, 21], "weight": 406 },
        { "vec": [-151, -82], "weight": 273 }, { "vec": [-128, -316], "weight": 49 },
        { "vec": [687, 354], "weight": 441 }, { "vec": [474, 451], "weight": 451 },
        { "vec": [382, 42], "weight": 263 }, { "vec": [248, 1], "weight": 389 },
        { "vec": [584, 21], "weight": 161 }, { "vec": [785, -215], "weight": 73 },
        { "vec": [824, 53], "weight": 86 }, { "vec": [919, 319], "weight": 285 },
        { "vec": [539, 463], "weight": 385 }, { "vec": [91, 590], "weight": 62 },
        { "vec": [-242, 538], "weight": 103 }, { "vec": [29, 453], "weight": 163 },
        { "vec": [-268, 508], "weight": 262 }, { "vec": [-5, 564], "weight": 489 },
        { "vec": [76, 524], "weight": 196 }, { "vec": [191, 505], "weight": 463 },
        { "vec": [697, 198], "weight": 333 }, { "vec": [755, 94], "weight": 318 },
        { "vec": [739, -132], "weight": 135 }, { "vec": [680, -259], "weight": 189 },
        { "vec": [666, -387], "weight": 315 }, { "vec": [424, -490], "weight": 125 },
        { "vec": [237, -569], "weight": 420 }, { "vec": [-15, -475], "weight": 203 },
        { "vec": [-230, -509], "weight": 194 }, { "vec": [19, -344], "weight": 469 },
        { "vec": [-162, -602], "weight": 284 }, { "vec": [192, -624], "weight": 202 },
        { "vec": [372, -614], "weight": 50 }, { "vec": [813, -408], "weight": 405 },
        { "vec": [980, -324], "weight": 110 }, { "vec": [1072, -513], "weight": 263 },
        { "vec": [860, -586], "weight": 118 }, { "vec": [749, -558], "weight": 176 },
        { "vec": [810, -365], "weight": 270 }, { "vec": [694, -381], "weight": 465 },
        { "vec": [824, -243], "weight": 498 }, { "vec": [354, 192], "weight": 393 },
        { "vec": [639, 206], "weight": 384 }, { "vec": [834, -75], "weight": 1 },
        { "vec": [658, -390], "weight": 122 }, { "vec": [428, -248], "weight": 185 },
        { "vec": [214, -207], "weight": 2 }, { "vec": [27, -508], "weight": 15 },
        { "vec": [791, 71], "weight": 39 }, { "vec": [826, 244], "weight": 58 },
        { "vec": [788, 368], "weight": 227 }, { "vec": [731, 518], "weight": 55 },
        { "vec": [736, 766], "weight": 249 }]
    }
};

const FlowsComp = {
    name: 'FlowsEft',
    id: 'test_Flows',
    renderSort: 5, // 当前组件的渲染顺序
    config: {
        offsetY: 1, // 整体高度偏移
        initTime: 3, // 初始化时间
        lightTime: 2, // 光效周期时长
        effectLen: 1000, // 光效限制长度
        isLight: true, // 是否开启光效
        mtl: {
            width: 3, //宽度
            effectRatio: 0.8, // 效果比例参数
            color: 'rgba(204, 204, 255, 0.5)', // 整体颜色
            txue: 'flows', //贴图名称
        },
        colors: [ // 随机颜色数组
            'rgba(40, 255, 11, 0.45)', 'rgba(255, 255, 0, 0.45)', 'rgba(0, 133, 255, 0.45)',
        ],
        data: [
            [[-1489, -1317], [-1299, -1165], [-901, -1031], [-538, -902], [150, -588],
            [360, -538], [886, -505], [1835, -479]],
            [[-538, -1845], [-507, 59], [-466, 171], [-462, 323], [668, 323], [1835, 323]],
            [[896, -1845], [885, -509], [876, 325], [863, 1036]],
            [[-1923, 858], [-1408, 825], [-1038, 809], [-532, 771], [334, 711], [864, 677], [1400, 649], [1840, 619]],
            [[157, -1335], [153, -53], [153, 318], [556, 327], [560, 694]],
            [[-1923, -244], [-1521, -246], [-899, -251], [-222, -267], [147, -277], [886, -282],
            [1272, -291], [1352, -282], [1432, -255], [1569, -239], [1837, -219]],
            [[-1917, 302], [-1410, 316], [-563, 319], [-556, 486], [-529, 607], [-540, 1121]],
            [[-1513, -1318], [-1513, -918], [-1513, -380], [-1516, 296], [-1417, 317], [-1409, 332], [-1400, 623], [-1394, 823]],
            [[-1047, 129], [-1043, -33], [-1025, -46], [-871, -48], [-846, -52], [-514, -55], [151, -54], [479, -49], [876, -57]]
        ],
    }
};

const FencesComp = {
    name: 'FencesEft',
    id: 'test_Fences',
    renderSort: 6, // 当前组件的渲染顺序
    config: {
        fire: [
            {
                points: [[-9, 500, 9]], //位置
                radius: 80, // 半径
                height: 1000, // 高度
                seg: 4, // 边数
                rotation: [[0.4, 0, 0]],
                color: '#EEFFB5' //颜色
            }
        ]
    }
};

// 初始化
instance.init({
    sort: true,
    sky: {
        created: true, // 是否创建
        currentSky: 'type_1', // name(初始天空盒，对应name) / null(初始不启动天空盒)
        environment: 'type_1', // 环境贴图
        skys: [
            {
                name: 'type_1',
                type: 'hdr', // 类别
                url: 'texture/quarry_01_1k.hdr'
            }
        ],
        material: []
    },
    // 基础配置
    render: {
        cts: 'canvas-frame', // 容器 dom 或id
        camera: {
            near: 4,
            far: 40000,
            position: { "x": -1.55, "y": 959.98, "z": 1.86 }
        },
        controls: {
            target: { "x": -1.54, "y": 200, "z": -2.45 }, // 中心位置
        }
    },
    components: [
        loadeComp,
        cameraComp,
        // glowsComp,
        htMapComp,
        FlowsComp,
        FencesComp
    ],
    loadEndCallback() {
        // 所有组件加载完毕回调
        // console.log(1)
        // setTimeout(() => {
        //     // instance.getComponent({ sort: 4 }).startInit(); // 初始相机角度
        //     document.querySelector('#loading').style.opacity = 1;
        //     instance.loadingHide(document.querySelector('#loading').style, { opacity: 0 }, () => {
        //         document.querySelector('#loading').remove();

        //         // instance.getComponent({ sort: 4 }).start();
        //     });

        // }, 200)
    },
    textures: [{
        id: 'loadRay',
        url: 'texture/loadVRay.jpg',
        isRepeat: true
    }, {
        id: 'waternormals',
        url: 'texture/waternormals.jpg',
        isRepeat: true
    }, {
        id: 'water',
        url: 'texture/water.jpg',
        isRepeat: true
    }, {
        id: 'flows',
        url: 'particle/smokeparticle1.png'
    }, , {
        id: 'box_glass',
        url: 'texture/box_glass.png',
        isRepeat: true
    }]
});

window._data = [];
window._data2 = [];
instance.on('onMouseDown', 'render', (e) => {
    if (instance.getComponent('render').isCtrl) {
        const vec3 = instance.trans({ x: e.offsetX, y: e.offsetY }, 1);
        console.log(vec3);

        _data.push([vec3.x | 0, vec3.z | 0]);
        _data2.push({
            vec: [vec3.x | 0, vec3.z | 0],
            weight: (Math.random() * 500) | 0
        });
    }
});

window._getVecs = function (type) {
    type ? console.log(JSON.stringify(_data)) : console.log(JSON.stringify(_data2));
    window._data = [];
    window._data2 = [];
}

</script>

</html>
